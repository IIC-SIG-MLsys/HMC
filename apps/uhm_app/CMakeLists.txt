cmake_minimum_required(VERSION 3.10)
project(uhm_app)

set(ENV{ASCEND_RT_VISIBLE_DEVICES} "0,1")

set(RDMA_SERVER_SOURCES server.cpp)
set(RDMA_CLIENT_SOURCES client.cpp)

add_executable(uhm_server ${RDMA_SERVER_SOURCES})
add_executable(uhm_client ${RDMA_CLIENT_SOURCES})

# ==============================
# 1. GPU / AI åŠ é€Ÿåº“æ£€æµ‹
# ==============================
if(ROCM_FOUND)
    target_link_libraries(uhm_server PRIVATE hmc_shared_lib ${HIP_LIBRARIES})
    target_link_libraries(uhm_client PRIVATE hmc_shared_lib ${HIP_LIBRARIES})
elseif(CUDA_FOUND)
    target_link_libraries(uhm_server PRIVATE hmc_shared_lib ${CUDA_LIBRARIES})
    target_link_libraries(uhm_client PRIVATE hmc_shared_lib ${CUDA_LIBRARIES})
elseif(NEUWARE_FOUND)
    target_link_libraries(uhm_server PRIVATE hmc_shared_lib ${NEUWARE_LIBRARIES})
    target_link_libraries(uhm_client PRIVATE hmc_shared_lib ${NEUWARE_LIBRARIES})
elseif(HUAWEI_FOUND)
    target_link_libraries(uhm_server PRIVATE hmc_shared_lib ${HUAWEI_LIBRARIES})
    target_link_libraries(uhm_client PRIVATE hmc_shared_lib ${HUAWEI_LIBRARIES})
elseif(MUSA_FOUND)
    target_link_libraries(uhm_server PRIVATE hmc_shared_lib ${MUSA_LIBRARIES})
    target_link_libraries(uhm_client PRIVATE hmc_shared_lib ${MUSA_LIBRARIES})
else()
    message(WARNING "ROCm, CUDA, NEUWARE, HUAWEI, or Moore Threads not found. Defaulting to CPU support.")
endif()

# ====== å…³é”®ä¿®å¤ 1: åœ¨é“¾æ¥å‰è®¾ç½®è·¯å¾„ ======
if(UCX_FOUND)
    # å…¨å±€åŒ…å«ç›®å½• (å½±å“æ‰€æœ‰å­é¡¹ç›®)
    include_directories(
        ${UCX_INCLUDE_DIRS}      # å…¬å…±å¤´æ–‡ä»¶
    )
    
    # å…¨å±€é“¾æ¥ç›®å½•
    link_directories(${UCX_LIBRARY_DIRS})
endif()

if(UCX_FOUND)
    target_link_libraries(uhm_server PRIVATE 
        ${UCX_LIBRARIES}
        pthread rt dl
    )
    target_link_libraries(uhm_client PRIVATE 
        ${UCX_LIBRARIES}
        pthread rt dl
    )
endif()

# ==============================
# 2. UCX é…ç½®ï¼ˆé€‚é…ç‰ˆï¼‰
# ==============================
set(UCX_ROOT /usr/local/ucx)

set(UCX_INCLUDE_DIR ${UCX_ROOT}/include)
set(UCX_LIBRARY_DIR ${UCX_ROOT}/lib)

# UCX ç»„ä»¶åº“
find_library(UCP_LIB ucp HINTS ${UCX_LIBRARY_DIR})
find_library(UCS_LIB ucs HINTS ${UCX_LIBRARY_DIR})
find_library(UCT_LIB uct HINTS ${UCX_LIBRARY_DIR})
find_library(UCM_LIB ucm HINTS ${UCX_LIBRARY_DIR})

if(UCP_LIB AND UCS_LIB AND UCT_LIB)
    message(STATUS "âœ… UCX found successfully:")
    message(STATUS "   Include: ${UCX_INCLUDE_DIR}")
    message(STATUS "   Libraries:")
    message(STATUS "      ${UCP_LIB}")
    message(STATUS "      ${UCS_LIB}")
    message(STATUS "      ${UCT_LIB}")
    message(STATUS "      ${UCM_LIB}")
else()
    message(FATAL_ERROR "âŒ UCX component libraries not found in ${UCX_LIBRARY_DIR}. Please check installation.")
endif()

# åŒ…å« UCX å¤´æ–‡ä»¶
target_include_directories(uhm_server PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${UCX_INCLUDE_DIR}
)
target_include_directories(uhm_client PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${UCX_INCLUDE_DIR}
)

# é“¾æ¥æ‰€æœ‰ UCX ç»„ä»¶åº“
target_link_libraries(uhm_server PRIVATE
    ${UCP_LIB}
    ${UCS_LIB}
    ${UCT_LIB}
    ${UCM_LIB}
    glog
)
target_link_libraries(uhm_client PRIVATE
    ${UCP_LIB}
    ${UCS_LIB}
    ${UCT_LIB}
    ${UCM_LIB}
    glog
)


# ==============================
# 3. Include ç›®å½•
# ==============================
target_include_directories(uhm_server PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${UCX_INCLUDE_DIR}
    $<$<BOOL:${MUSA_FOUND}>:${MUSA_INCLUDE_DIRS}>
)

target_include_directories(uhm_client PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${UCX_INCLUDE_DIR}
    $<$<BOOL:${MUSA_FOUND}>:${MUSA_INCLUDE_DIRS}>
)

# ==============================
# 4. é“¾æ¥åº“
# ==============================
target_link_libraries(uhm_server PRIVATE ${UCX_LIB} glog)
target_link_libraries(uhm_client PRIVATE ${UCX_LIB} glog)

# ==============================
# 5. é¢å¤–è°ƒè¯•ä¿¡æ¯
# ==============================
message(STATUS "ğŸ’¡ Summary:")
message(STATUS "   Server include dirs: ${CMAKE_SOURCE_DIR}/include, ${UCX_INCLUDE_DIR}")
message(STATUS "   UCX library: ${UCX_LIB}")
message(STATUS "   C++ compiler: ${CMAKE_CXX_COMPILER}")
message(STATUS "   Build type: ${CMAKE_BUILD_TYPE}")
